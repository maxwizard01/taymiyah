<!DOCTYPE html>
<html>
<head>
    <title>Encrypt & QR Code Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h2>Encrypt → QR Code</h2>
<input id="inputText" placeholder="Enter text to encrypt" style="width:300px;">
<input id="password" placeholder="Password" style="width:200px;">
<button  id="GenerateBtn" onclick="encryptAndGenerateQR()">Encrypt & Create QR</button>

<div id="qrcode" style="margin-top:20px;"></div>

<hr>

<h2>Scan QR → Decrypt</h2>
<div id="reader" style="width:300px;"></div>
<button onclick="startScan()" id="DegenerateBtn">Start Scanner</button>

<p><b>Decrypted Text:</b></p>
<p id="decryptedOutput"></p>

<script >
    // Encode and decode helpers
const enc = new TextEncoder();
const dec = new TextDecoder();

// Convert array buffer -> base64
function toBase64(buffer) {
    return btoa(String.fromCharCode(...new Uint8Array(buffer)));
}

// Convert base64 -> array buffer
function fromBase64(base64) {
    return Uint8Array.from(atob(base64), c => c.charCodeAt(0));
}

// Derive key from password
async function deriveKey(password, salt) {
    const keyMaterial = await crypto.subtle.importKey(
        "raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]
    );

    return crypto.subtle.deriveKey(
        {
            name: "PBKDF2",
            salt,
            iterations: 100000,
            hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
    );
}

// Encrypt text
async function encryptText(text, password) {
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const iv = crypto.getRandomValues(new Uint8Array(12));

    const key = await deriveKey(password, salt);

    const encrypted = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        key,
        enc.encode(text)
    );

    return {
        salt: toBase64(salt),
        iv: toBase64(iv),
        ciphertext: toBase64(encrypted)
    };
}

// Decrypt text
async function decryptText(encryptedObj, password) {
    const salt = fromBase64(encryptedObj.salt);
    const iv = fromBase64(encryptedObj.iv);
    const ciphertext = fromBase64(encryptedObj.ciphertext);

    const key = await deriveKey(password, salt);

    const decrypted = await crypto.subtle.decrypt(
        { name: "AES-GCM", iv },
        key,
        ciphertext
    );

    return dec.decode(decrypted);
}

// ----------- QR GENERATION ------------- //

async function encryptAndGenerateQR() {
    let text=document.getElementById('GenerateBtn')
    let password='123Police'
    if (!text || !password) {
        alert("Enter text and password!");
        return;
    }

    const encrypted = await encryptText(text, password);

    const jsonString = JSON.stringify(encrypted);

    // Clear previous QR
    document.getElementById("qrcode").innerHTML = "";

    new QRCode(document.getElementById("qrcode"), jsonString);
}

// ----------- QR SCANNING ------------- //

function startScan() {
    const reader = new Html5Qrcode("reader");

    reader.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        async (qrText) => {
            reader.stop();

            try {
                const encryptedObj = JSON.parse(qrText);
                const password = prompt("Enter password to decrypt:");

                const decrypted = await decryptText(encryptedObj, password);
                document.getElementById("decryptedOutput").innerText = decrypted;

            } catch (err) {
                alert("Invalid QR code or wrong password!");
            }
        }
    );
}

</script>
</body>
</html>
